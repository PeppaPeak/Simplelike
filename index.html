<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Single-file Roguelike (Prototype) - With Waves</title>
<style>
  :root{
    --ui-bg: #ffffff;
    --accent: #0b66ff;
    --card-bg: rgba(255,255,255,0.98);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%;margin:0;background:#f7f7f7;}
  #container{display:flex;justify-content:center;padding:24px;}
  canvas{background: #fff; border: 1px solid #e3e3e3; box-shadow: 0 0 0 1px rgba(0,0,0,0.02) inset;}
  /* UI */
  .ui {
    position: absolute; left:28px; top:18px; width:260px;
    background:var(--card-bg); border-radius:8px; padding:12px; box-shadow:0 6px 18px rgba(0,0,0,0.08);
    color:#222; font-size:13px;
  }
  .hp-bar {height:10px; background:#eee; border-radius:6px; overflow:hidden; margin-bottom:8px;}
  .hp-fill {height:100%; background:linear-gradient(90deg,var(--accent), #3bb0ff); width:100%;}
  .small {color:#666; font-size:12px;}
  .bottom-left {position:absolute; left:340px; bottom:40px; color:#444; font-size:13px;}
  /* Card popup */
  .overlay {position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.25); z-index:50;}
  .card-panel {background:white; padding:18px; border-radius:10px; width:740px; display:flex; gap:12px; box-shadow:0 20px 60px rgba(0,0,0,0.25);}
  .card {flex:1; border-radius:8px; padding:12px; border:1px solid #eee; cursor:pointer; transition:transform .12s ease, box-shadow .12s ease;}
  .card:hover{transform:translateY(-6px); box-shadow:0 10px 30px rgba(0,0,0,0.12);}
  .card .title{font-weight:600; margin-bottom:6px;}
  .card .desc{font-size:13px; color:#555; min-height:44px;}
  .info {font-size:13px; color:#333; margin-top:8px;}
  .muted {color:#888; font-size:12px;}
  .center {text-align:center;}
  .button {padding:8px 12px; background:var(--accent); color:white; border-radius:6px; display:inline-block; cursor:pointer;}
  footer {position:fixed; right:18px; bottom:8px; color:#999; font-size:12px;}
  .wave-desc {position:fixed; left:50%; transform:translateX(-50%); bottom:12px; background:white; padding:8px 14px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.08); color:#333; font-weight:600;}
</style>
</head>
<body>
<div id="container">
  <canvas id="game" width="1200" height="700"></canvas>
</div>

<div class="ui" id="ui">
  <div style="font-weight:700">HP</div>
  <div class="hp-bar"><div id="hpfill" class="hp-fill"></div></div>
  <div id="ui-text" class="small">XP: 0 | Level: 1 | Weapon: -</div>
  <div class="small" style="margin-top:8px">Move: WASD / Arrows</div>
</div>

<div class="bottom-left" id="bottomstats">Enemies: 0 &nbsp;&nbsp; Bullets: 0 &nbsp;&nbsp; XP:0/3</div>
<div id="waveDesc" class="wave-desc">Wave 1 - Easy: Meatshield</div>

<footer>Single-file roguelike â€¢ Kill enemies for XP & choose upgrades</footer>

<script>
// Full script with weapon stacking and continuous waves

const CONFIG = {
  canvas: { w: 1000, h: 600 },
  maxEnemies: 20,
  player: { maxHp: 10, speed: 180 },
  xpToLevel: lvl => 3 + lvl,
  spawnDelayBetweenWaveEnemies: 220,
};

const WEAPON_TEMPLATES = {
  rotating_orb: { id:'rotating_orb', name:'Rotating Orb', type:'orb', baseDamage:1, data:{count:1, speed:2.2}, desc:'Rotates around player dealing damage.'},
  buckshot:      { id:'buckshot', name:'Buckshot', type:'projectile', baseDamage:1, data:{bullets:5, spread:0.55, rate:1.2, speed:380}, desc:'Shoots cluster to nearest enemy.'},
  rocket:        { id:'rocket', name:'Rocket Launcher', type:'projectile', baseDamage:3, data:{rate:0.45, speed:240, splash:28, splashDamage:2}, desc:'Slow rocket with splash.'},
  chain:         { id:'chain', name:'Chain', type:'chain', baseDamage:1, data:{range:120, chains:2, rate:1.1}, desc:'Zaps nearby enemies and chains.'},
  scythe:        { id:'scythe', name:'Scythe', type:'scythe', baseDamage:0, data:{poison:1, lifetime:1600, rate:0.8, pierce:true}, desc:'Throws a scythe that poisons.'},
  minions:       { id:'minions', name:'Minions', type:'minions', baseDamage:1, data:{count:1, spawnInterval:2500}, desc:'Spawns helper minions.'},
  ring:          { id:'ring', name:'Ring', type:'ring', baseDamage:1, data:{dirs:8, rate:0.6, speed:260}, desc:'Fires bullets in many directions.'}
};

const UPGRADE_OPTIONS = {
  rotating_orb:[
    {title:'Faster Rotation', apply:w=>w.data.speed*=1.6, desc:'Orbs rotate faster.'},
    {title:'More Orbs', apply:w=>w.data.count+=1, desc:'Adds another orb.'},
    {title:'More Damage', apply:w=>w.baseDamage+=1, desc:'Orbs deal more damage.'},
  ],
  buckshot:[
    {title:'More Bullets', apply:w=>w.data.bullets+=2, desc:'Shoot more pellets.'},
    {title:'Faster Fire Rate', apply:w=>w.data.rate*=1.35, desc:'Shoot faster.'},
    {title:'More Damage', apply:w=>w.baseDamage+=1, desc:'Pellets do more damage.'},
  ],
  rocket:[
    {title:'More Damage', apply:w=>w.baseDamage+=1, desc:'Rockets hit harder.'},
    {title:'Larger Splash', apply:w=>w.data.splash+=12, desc:'Splash radius increases.'},
    {title:'More Splash Damage', apply:w=>w.data.splashDamage+=1, desc:'Increase splash damage.'},
  ],
  chain:[
    {title:'More Damage', apply:w=>w.baseDamage+=1, desc:'Chains do more damage.'},
    {title:'Faster Rate', apply:w=>w.data.rate*=1.4, desc:'Zap more often.'},
    {title:'Longer Chains', apply:w=>w.data.chains+=1, desc:'Chains chain further.'},
  ],
  scythe:[
    {title:'Longer Poison', apply:w=>w.data.lifetime+=800, desc:'Poison lasts longer.'},
    {title:'Faster Rate', apply:w=>w.data.rate*=1.3, desc:'Throw scythes more often.'},
    {title:'More Poison Damage', apply:w=>w.data.poison+=1, desc:'Poison ticks more.'},
  ],
  minions:[
    {title:'More Minions', apply:w=>w.data.count+=1, desc:'Spawn more minions.'},
    {title:'Square Minion', apply:w=>w.minionType='square', desc:'Minions become tanky squares.'},
    {title:'Faster Minion Spawns', apply:w=>w.data.spawnInterval=Math.max(600,w.data.spawnInterval*0.7), desc:'Minions spawn faster.'},
  ],
  ring:[
    {title:'More Bullets', apply:w=>w.data.dirs+=4, desc:'More directions.'},
    {title:'Faster Rate', apply:w=>w.data.rate*=1.4, desc:'Shoot ring faster.'},
    {title:'More Damage', apply:w=>w.baseDamage+=1, desc:'Ring bullets hit harder.'},
  ],
};

const ENEMIES = {
  circle:      {shape:'circle', hp:3, speed:56, color:'#ff5a5a', immune:{}, xp:1},
  square:      {shape:'square', hp:9, speed:28, color:'#c93c3c', immune:{}, xp:3},
  triangle:    {shape:'triangle', hp:2, speed:120, color:'#ff8b8b', immune:{}, xp:1},
  pentagon:    {shape:'pentagon', hp:6, speed:70, color:'#8b5cff', immune:{splash:true}, xp:2},
  hexagon:     {shape:'hexagon', hp:12, speed:72, color:'#4caf50', immune:{poison:true}, xp:3},
  heptagon:    {shape:'heptagon', hp:13, speed:95, color:'#2b7f37', immune:{}, xp:4},
  octagon:     {shape:'octagon', hp:10, speed:58, color:'#ff79b1', immune:{}, xp:3},
  heavy:       {shape:'hendecagon', hp:20, speed:26, color:'#0f2f66', immune:{all:true}, xp:6},
  boss:        {shape:'ennea', hp:60, speed:16, color:'#6b2a6b', immune:{}, xp:20},
  pentadecagon:{shape:'pentadecagon', hp:8, speed:22, color:'#ff9ad1', immune:{}, xp:4, ranged:true, damage:3, rate:0.6}
};

// Preset waves remain unchanged
const PRESET_WAVES = [
  ['circle','circle','circle','circle','circle'],
  Array(10).fill('circle').concat(['square']),
  Array(5).fill('square'),
  Array(10).fill('square').concat(Array(3).fill('triangle')),
  Array(5).fill('triangle').concat(Array(3).fill('pentagon')),
  Array(15).fill('circle').concat(Array(10).fill('square')).concat(Array(5).fill('triangle')),
  Array(5).fill('pentagon'),
  Array(10).fill('pentagon').concat(Array(3).fill('heptagon')).concat(['hexagon']),
  Array(25).fill('circle').concat(Array(5).fill('octagon')).concat(Array(10).fill('square')),
  ['circle','square','triangle','heavy']
];

// Wave classification function unchanged
function classifyWave(enemyList){
  const counts = {};
  enemyList.forEach(n => counts[n] = (counts[n]||0)+1);
  const total = enemyList.length;
  const meatshieldScore = (counts['square']||0) + (counts['circle']||0) + (counts['heavy']||0);
  const spamScore = (counts['triangle']||0) + (counts['circle']||0);
  const rangedScore = (counts['pentadecagon']||0) + (counts['pentagon']||0) + (counts['hexagon']||0);
  if(total >= 20 && spamScore / total > 0.45) return 'Spam wave (lots of fast weak enemies)';
  if(meatshieldScore / Math.max(1,total) > 0.5) return 'Meatshield wave (tanky bodies up front)';
  if(rangedScore > 0) return 'Ranged wave (turrets and ranged threats)';
  if(total >= 15) return 'Hard / Mixed wave';
  return 'Normal wave';
}

// ---------------- Engine state
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = CONFIG.canvas.w;
canvas.height = CONFIG.canvas.h;

let keys = {};
let lastTime = performance.now();
let enemies = [];
let bullets = [];
let enemyBullets = [];
let orbs = [];
let minions = [];
let effects = [];
let spawnQueue = [];
let wave = 1;
let waveInProgress = false;
let waveSpawnIndex = 0;
let waveEnemySpawnTimer = 0;
let gamePaused = false;
let cardOverlay = null;

// Player object
let player = {
  x: canvas.width/2, y: canvas.height/2,
  hp: CONFIG.player.maxHp, maxHp: CONFIG.player.maxHp,
  speed: CONFIG.player.speed, level:1, xp:0, kills:0,
  ownedWeapons:{}, currentWeaponId:null
};

// Utils
const rand = (a,b)=> a + Math.random()*(b-a);
const choose = arr => arr[Math.floor(Math.random()*arr.length)];
const dist = (x1,y1,x2,y2)=> Math.hypot(x1-x2,y1-y2);
const clamp = (v,a,b)=> Math.max(a, Math.min(b, v));
const now = ()=> performance.now();

// Weapon instance factory
function createWeaponInstance(id){
  const t = WEAPON_TEMPLATES[id];
  if(!t) return null;
  return {
    id: t.id, name: t.name, type: t.type,
    baseDamage: t.baseDamage,
    data: JSON.parse(JSON.stringify(t.data || {})),
    desc: t.desc, lastShot: 0, minionType:'base'
  };
}

// Initialize first weapon
(function initWeapon(){
  const keys = Object.keys(WEAPON_TEMPLATES);
  const pick = choose(keys);
  player.ownedWeapons[pick] = createWeaponInstance(pick);
  player.currentWeaponId = pick;
})();

// --- Input ---
window.addEventListener('keydown', e=> { keys[e.key.toLowerCase()] = true; if(e.key===' '){e.preventDefault();}});
window.addEventListener('keyup', e=> { keys[e.key.toLowerCase()] = false; });

// --- Enemy spawn ---
function spawnEnemyByName(name, extra = {}) {
  const template = ENEMIES[name] || ENEMIES.circle;
  const side = Math.floor(Math.random() * 4);
  let x, y;
  if(side===0){ x=-30; y=rand(30, canvas.height-30);}
  else if(side===1){ x=canvas.width+30; y=rand(30, canvas.height-30);}
  else if(side===2){ y=-30; x=rand(30, canvas.width-30);}
  else { y=canvas.height+30; x=rand(30, canvas.width-30);}
  const immune = structuredClone(template.immune||{});
  const sidesMap = {circle:0, square:4, triangle:3, pentagon:5, hexagon:6, heptagon:7, octagon:8, hendecagon:11, ennea:91, pentadecagon:15};
  const sides = sidesMap[template.shape] || 0;
  const e = {
    id: "e_" + Math.random().toString(36).slice(2),
    name,
    templateName: name,
    shape: template.shape,
    sides,
    x, y,
    hp: template.hp,
    maxHp: template.hp,
    speed: template.speed,
    color: template.color,
    size: extra.size||14,
    immune,
    xp: template.xp||1,
    ranged: template.ranged||false,
    damage: template.damage||1,
    rate: template.rate||0.8,
    lastShot: 0,
    aiKeepDist: !!template.ranged,
    target: null
  };
  enemies.push(e);
  return e;
}

// --- Wave preparation ---
function prepareWave(n){
  wave = n;
  enemies.length=0; bullets.length=0; enemyBullets.length=0; orbs.length=0; minions.length=0;
  spawnQueue.length=0; waveInProgress=true; waveSpawnIndex=0; waveEnemySpawnTimer=0;
  if(n <= PRESET_WAVES.length) spawnQueue.push(...PRESET_WAVES[n-1]);
  else {
    const count = Math.min(30, 4 + Math.floor(n*1.3));
    const pool = [];
    for(let i=0;i<count;i++){
      const r=Math.random();
      if(n<6) pool.push(Math.random()<0.65?'circle':(Math.random()<0.5?'triangle':'square'));
      else if(n<10) pool.push(Math.random()<0.5?'square':(Math.random()<0.55?'circle':'pentagon'));
      else {
        const pick=Math.random();
        if(pick<0.12) pool.push('heavy');
        else if(pick<0.22) pool.push('heptagon');
        else if(pick<0.35) pool.push('pentadecagon');
        else if(pick<0.6) pool.push('square');
        else pool.push('circle');
      }
    }
    spawnQueue.push(...pool);
  }
  const desc = classifyWave(spawnQueue);
  document.getElementById
